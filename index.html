<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>センサー値を表示</title>
  </head>
  <body>
    <main>
      
      <ul id="output" style="display: none;">
        <li id="latitude">0</li>
        <li id="longitude">0</li>
        <li id="altitude">0</li>
        <li id="accuracy">0</li>
        <li id="altitudeAccuracy">0</li>
        <li id="webkitCompassHeading">0</li>
        <li id="webkitCompassAccuracy">0</li>
        <li id="alpha">0</li>
        <li id="beta">0</li>
        <li id="gamma">0</li>
        <li id="accelerationX">0</li>
        <li id="accelerationY">0</li>
        <li id="accelerationZ">0</li>
        <li id="accelerationIncludingGravityX">0</li>
        <li id="accelerationIncludingGravityY">0</li>
        <li id="accelerationIncludingGravityZ">0</li>
        <li id="rotationRateAbsolute">0</li>
        <li id="rotationRateAlpha">0</li>
        <li id="rotationRateBeta">0</li>
        <li id="rotationRateGamma">0</li>
      </ul>
    </main>
    <script src="/node_modules/jquery/dist/jquery.min.js"></script>
    <script>
      'use strict';
      const fail = () => $('#permbtn').text('ごめん無理だった…。');
      const succ = () => {
        $('#permbtn').css('display', 'none');
        $('#output').css('display', 'block');
        $(window).on("devicemotion", e => devMo);
        $(window).on("deviceorientation", e => devOr);
        setInterval(() => {
          $('#webkitCompassHeading').text('webkitCompassHeading: ' + objdata.webkitCompassHeading);
          $('#webkitCompassAccuracy').text('webkitCompassAccuracy: ' + objdata.webkitCompassAccuracy);
          $('#alpha').text('alpha: ' + objdata.alpha);
          $('#beta').text('beta: ' + objdata.beta);
          $('#gamma').text('gamma: ' + objdata.gamma);
          $('#accelerationX').text('accelerationX: ' + objdata.acceleration.x);
          $('#accelerationY').text('accelerationY: ' + objdata.acceleration.y);
          $('#accelerationZ').text('accelerationZ: ' + objdata.acceleration.z);
          $('#accelerationIncludingGravityX').text('accelerationIncludingGravityX: ' + objdata.accelerationIncludingGravity.x);
          $('#accelerationIncludingGravityY').text('accelerationIncludingGravityY: ' + objdata.accelerationIncludingGravity.y);
          $('#accelerationIncludingGravityZ').text('accelerationIncludingGravityZ: ' + objdata.accelerationIncludingGravity.z);
          $('#rotationRateAlpha').text('rotationRateAlpha: ' + objdata.rotationRate.alpha);
          $('#rotationRateBeta').text('rotationRateBeta: ' + objdata.rotationRate.beta);
          $('#rotationRateGamma').text('rotationRateGamma: ' + objdata.rotationRate.gamma);
        }, 33);
      };

      const objdata = {
        webkitCompassHeading: 0,
        webkitCompassAccurac: 0,
        alpha: 0,
        beta: 0,
        gamma: 0,
        acceleration: {
          x: 0,
          y: 0,
          z: 0
        },
        accelerationIncludingGravity: {
          x: 0,
          y: 0,
          z: 0
        },
        rotationRate: {
          alpha: 0,
          beta: 0,
          gamma: 0
        }
      };

      function rp() {
        let mps = false, ops = false;
        DeviceMotionEvent.requestPermission().then(res => {mps = (res === 'granted');}).catch();
        DeviceOrientationEvent.requestPermission().then(res => {ops = (res === 'granted');}).catch();
        if (mps && ops) {
          succ();
        } else {
          fail();
          // $('#permbtn').text(`ごめん${mps}無理だった…。`)
        };
      };

      navigator.geolocation.getCurrentPosition(e => {
        $('#latitude').text(`latitude: ${e.coords.latitude}`);
        $('#longitude').text(`longitude: ${e.coords.longitude}`);
        $('#altitude').text(`altitude: ${e.coords.altitude}`);
        $('#accuracy').text(`accuracy: ${e.coords.accuracy}`);
        $('#altitudeAccuracy').text(`altitudeAccuracy: ${e.coords.altitudeAccuracy}`);
      });
      const devMo = e => {
        objdata.acceleration.x              = e.acceleration.x;
        objdata.acceleration.y              = e.acceleration.y;
        objdata.acceleration.z              = e.acceleration.z;
        objdata.accelerationIncludingGravity.x  = e.accelerationIncludingGravity.x;
        objdata.accelerationIncludingGravity.y  = e.accelerationIncludingGravity.y;
        objdata.accelerationIncludingGravity.z  = e.accelerationIncludingGravity.z;
        objdata.rotationRate.alpha          = e.rotationRate.alpha;
        objdata.rotationRate.beta           = e.rotationRate.beta;
        objdata.rotationRate.gamma          = e.rotationRate.gamma;
      };
      const devOr = e => {
        objdata.webkitCompassHeading    = e.webkitCompassHeading;
        objdata.webkitCompassAccuracy = e.webkitCompassAccuracy;
        objdata.alpha           = e.alpha;
        objdata.beta              = e.beta;
        objdata.gamma           = e.gamma;
      };
      const init = () => {
        if (window.DeviceMotionEvent && window.DeviceOrientationEvent) {
          if (DeviceMotionEvent.requestPermission && typeof DeviceMotionEvent.requestPermission === 'function' && DeviceOrientationEvent.requestPermission && typeof DeviceOrientationEvent.requestPermission === 'function') {
            $('main').prepend($('<button id="permbtn" onclick="rp();">').text('んげん').on('click', rp));
          } else {
            succ();
          };
        } else {
          fail();
        };
        $('#permbtn').css('display', 'block');
      };
      $(() => {
        init();
      })
    </script>
  </body>
</html>